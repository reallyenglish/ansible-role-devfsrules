---
- hosts: server
  become: yes
  become_method: sudo
  environment:
    http_proxy: "{{ http_proxy | default() }}"
    https_proxy: "{{ https_proxy | default() }}"
    no_proxy: "{{ no_proxy | default() }}"

  vars:
    devfsrules:
      - name: permit_bpf
        number: 200
        rules: |
          add path 'bpf' user root
          add path 'bpf' group network
          add path 'bpf' mode 660
    devfsrules_devfs_system_ruleset:
      - permit_bpf
  pre_tasks:
  roles:
    - ansible-role-devfsrules
  post_tasks:
    - name: See if /dev/bpf is grouped into group `network`
      stat:
        path: /dev/bpf
      register: register_bpf

    - name: Test group network has access to /dev/bpf
      # it has be tested here, not in spec. the spec files are executed *after*
      # the play. what is being tested here is the role applies the changes to
      # the system *during* the play.
      assert:
        that:
          - register_bpf.stat.pw_name == 'root'
          - register_bpf.stat.gr_name == 'network'
          - register_bpf.stat.mode == "0660"

    - name: Add vagrant to network group
      user:
        name: vagrant
        groups: network
        append: yes
